<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å›¾ç‰‡é‡å‘½åæ‰“åŒ…å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; background: #f0f2f5; }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        
        .mode-selection { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .mode-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .mode-card { border: 2px solid #e0e0e0; padding: 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .mode-card:hover { border-color: #4CAF50; transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .mode-icon { font-size: 48px; margin-bottom: 10px; }
        .mode-title { font-weight: bold; font-size: 18px; margin-bottom: 8px; color: #2c3e50; }
        .mode-desc { font-size: 14px; color: #666; }
        
        .work-section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; }
        .work-section.active { display: block; }
        
        .config-section { background: #f4f7f6; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        
        .upload-area { border: 2px dashed #bbb; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; background: white; }
        .upload-area:hover { border-color: #4CAF50; background: #f9f9f9; }
        
        #imageList { margin-top: 20px; }
        .image-item { display: flex; align-items: center; background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0; }
        .image-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
        .image-info { flex: 1; }
        .original-name { font-size: 13px; color: #999; margin-bottom: 4px; }
        .new-name { font-size: 15px; color: #333; font-weight: 500; }
        .remove-btn { background: #ff4757; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .remove-btn:hover { background: #ff3838; }
        
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px 5px; transition: 0.3s; }
        .btn:hover { background: #45a049; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-export { background: #2196F3; }
        .btn-export:hover { background: #0b7dda; }
        .btn-next { background: #ff9800; }
        .btn-next:hover { background: #e68900; }
        
        .button-group { text-align: center; margin-top: 20px; }
        .status { text-align: center; color: #666; margin: 15px 0; font-size: 16px; }
        
        .current-box { background: white; padding: 15px; border-radius: 6px; text-align: center; }
        .current-box-number { font-size: 24px; font-weight: bold; color: #4CAF50; }
        
        .pair-indicator { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: bold; margin-left: 10px; }
        .pair-1 { background: #e3f2fd; color: #1976d2; }
        .pair-2 { background: #fff3e0; color: #f57c00; }
    </style>
</head>
<body>

    <h2>ğŸ“¸ å›¾ç‰‡é‡å‘½åæ‰“åŒ…å·¥å…·</h2>
    
    <!-- æ¨¡å¼é€‰æ‹©ç•Œé¢ -->
    <div id="modeSelection" class="mode-selection">
        <p style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">è¯·é€‰æ‹©é‡å‘½åæ¨¡å¼ï¼š</p>
        <div class="mode-grid">
            <div class="mode-card" onclick="selectMode('unbox')">
                <div class="mode-icon">ğŸ“¦</div>
                <div class="mode-title">å¼€ç®±æ¨¡å¼</div>
                <div class="mode-desc">å‘½åè§„åˆ™ï¼š1-1, 1-2<br>æ¯ç®±æœ€å¤š2å¼ ï¼Œæ»¡2è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ç®±</div>
            </div>
            <div class="mode-card" onclick="selectMode('receive')">
                <div class="mode-icon">ğŸšš</div>
                <div class="mode-title">æ”¶è´§æ¨¡å¼</div>
                <div class="mode-desc">å‘½åè§„åˆ™ï¼š1-1, 1-2, 1-3...<br>æ‰‹åŠ¨åˆ‡æ¢ä¸‹ä¸€è½¦</div>
            </div>
            <div class="mode-card" onclick="selectMode('normal')">
                <div class="mode-icon">ğŸ“·</div>
                <div class="mode-title">æ™®é€šæ¨¡å¼</div>
                <div class="mode-desc">æŒ‰æ—¶é—´é¡ºåºå‘½å<br>1, 2, 3...</div>
            </div>
        </div>
    </div>

    <!-- å·¥ä½œç•Œé¢ -->
    <div id="workSection" class="work-section">
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="backToModeSelection()">â† è¿”å›æ¨¡å¼é€‰æ‹©</button>
            <span style="margin-left: 15px; font-weight: bold; color: #4CAF50;" id="currentMode"></span>
        </div>

        <div class="config-section" id="configSection">
            <!-- é…ç½®åŒºåŸŸæ ¹æ®æ¨¡å¼åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="config-section">
            <p><strong>é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</strong></p>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“</div>
                ç‚¹å‡»æ­¤å¤„ä¸Šä¼ å›¾ç‰‡ (æ”¯æŒå¤šé€‰)
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
            </div>
        </div>

        <div class="status" id="status">å·²é€‰æ‹© 0 å¼ å›¾ç‰‡</div>
        <div id="imageList"></div>

        <div class="button-group">
            <button class="btn btn-secondary" id="clearBtn" onclick="clearAll()" style="display: none;">æ¸…ç©ºåˆ—è¡¨</button>
            <button class="btn btn-next" id="nextBtn" onclick="nextBox()" style="display: none;">ä¸‹ä¸€ç®±/è½¦ â†’</button>
            <button class="btn btn-export" id="exportBtn" onclick="exportZip()" style="display: none;">æ‰“åŒ…å¹¶å¯¼å‡º ZIP</button>
        </div>
    </div>

    <script>
        let currentMode = '';
        let images = [];
        let currentBoxNum = 1; // å¼€ç®±/æ”¶è´§æ¨¡å¼ï¼šå½“å‰ç®±å·/è½¦æ¬¡
        let currentPosInBox = 1; // å½“å‰ç®±/è½¦å†…çš„ä½ç½®

        const fileInput = document.getElementById('fileInput');
        const imageList = document.getElementById('imageList');
        const status = document.getElementById('status');

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('workSection').classList.add('active');
            
            const modeNames = {
                'unbox': 'ğŸ“¦ å¼€ç®±æ¨¡å¼',
                'receive': 'ğŸšš æ”¶è´§æ¨¡å¼',
                'normal': 'ğŸ“· æ™®é€šæ¨¡å¼'
            };
            document.getElementById('currentMode').textContent = modeNames[mode];
            
            setupConfig();
        }

        function backToModeSelection() {
            if (images.length > 0 && !confirm('è¿”å›å°†æ¸…ç©ºå·²é€‰å›¾ç‰‡ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')) {
                return;
            }
            images = [];
            currentBoxNum = 1;
            currentPosInBox = 1;
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('workSection').classList.remove('active');
            renderImages();
        }

        function setupConfig() {
            const configSection = document.getElementById('configSection');
            const nextBtn = document.getElementById('nextBtn');
            
            if (currentMode === 'unbox') {
                configSection.innerHTML = `
                    <p><strong>å½“å‰ç®±å·</strong></p>
                    <div class="current-box">
                        <div class="current-box-number" id="boxDisplay">ç®±å· ${currentBoxNum}</div>
                        <div style="font-size: 14px; color: #666; margin-top: 8px;">æ¯ç®±æœ€å¤š2å¼ ï¼Œæ»¡2å¼ è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ç®±</div>
                    </div>
                `;
                nextBtn.style.display = 'inline-block';
                nextBtn.textContent = 'ä¸‹ä¸€ç®± â†’';
            } else if (currentMode === 'receive') {
                configSection.innerHTML = `
                    <p><strong>å½“å‰è½¦æ¬¡</strong></p>
                    <div class="current-box">
                        <div class="current-box-number" id="boxDisplay">è½¦æ¬¡ ${currentBoxNum}</div>
                        <div style="font-size: 14px; color: #666; margin-top: 8px;">æ¯è½¦ä¸é™æ•°é‡ï¼Œæ‰‹åŠ¨ç‚¹å‡»"ä¸‹ä¸€è½¦"åˆ‡æ¢</div>
                    </div>
                `;
                nextBtn.style.display = 'inline-block';
                nextBtn.textContent = 'ä¸‹ä¸€è½¦ â†’';
            } else if (currentMode === 'normal') {
                configSection.innerHTML = `
                    <p><strong>æ™®é€šæ¨¡å¼</strong></p>
                    <div style="background: white; padding: 15px; border-radius: 6px;">
                        <p style="margin: 0; color: #666;">æŒ‰æ—¶é—´é¡ºåºè‡ªåŠ¨å‘½åä¸º 1.jpg, 2.jpg, 3.jpg...</p>
                    </div>
                `;
                nextBtn.style.display = 'none';
            }
        }

        function nextBox() {
            currentBoxNum++;
            currentPosInBox = 1;
            const label = currentMode === 'unbox' ? 'ç®±å·' : 'è½¦æ¬¡';
            if (document.getElementById('boxDisplay')) {
                document.getElementById('boxDisplay').textContent = `${label} ${currentBoxNum}`;
            }
        }

        // ä»æ–‡ä»¶åæå–æ—¶é—´æˆ³ï¼ˆæ ¼å¼ï¼š20260104_104839.jpgï¼‰
        function getFileTimestamp(filename) {
            const match = filename.match(/(\d{8}_\d{6})/);
            if (match) {
                const dateStr = match[1];
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                const hour = dateStr.substring(9, 11);
                const minute = dateStr.substring(11, 13);
                const second = dateStr.substring(13, 15);
                const date = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`);
                return date.getTime();
            }
            // å¦‚æœæ— æ³•è§£æï¼Œä½¿ç”¨æ–‡ä»¶åä½œä¸ºå¤‡é€‰æ’åº
            return Date.now();
        }

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // å¼€ç®±æ¨¡å¼é™åˆ¶
            if (currentMode === 'unbox') {
                const currentBoxImages = images.filter(img => img.boxNum === currentBoxNum);
                const canAdd = 2 - currentBoxImages.length;
                if (files.length > canAdd) {
                    alert(`å½“å‰ç®±æœ€å¤šè¿˜èƒ½æ·»åŠ  ${canAdd} å¼ å›¾ç‰‡ï¼`);
                    fileInput.value = '';
                    return;
                }
            }

            // æŒ‰æ–‡ä»¶åæ—¶é—´æˆ³æ’åº
            const sortedFiles = files.sort((a, b) => {
                return getFileTimestamp(a.name) - getFileTimestamp(b.name);
            });

            let loadedCount = 0;
            
            sortedFiles.forEach((file, fileIndex) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const timestamp = getFileTimestamp(file.name);
                    
                    const img = {
                        id: Date.now() + Math.random(),
                        file: file,
                        originalName: file.name,
                        dataUrl: event.target.result,
                        extension: file.name.split('.').pop(),
                        timestamp: timestamp
                    };
                    
                    if (currentMode === 'unbox' || currentMode === 'receive') {
                        img.boxNum = currentBoxNum;
                        img.posInBox = currentPosInBox;
                        img.newName = `${currentBoxNum}-${currentPosInBox}.${img.extension}`;
                        currentPosInBox++;
                        
                        // å¼€ç®±æ¨¡å¼ï¼šæ»¡2å¼ è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ç®±
                        if (currentMode === 'unbox' && currentPosInBox > 2) {
                            currentBoxNum++;
                            currentPosInBox = 1;
                            const label = 'ç®±å·';
                            if (document.getElementById('boxDisplay')) {
                                document.getElementById('boxDisplay').textContent = `${label} ${currentBoxNum}`;
                            }
                        }
                    } else {
                        // æ™®é€šæ¨¡å¼ï¼šæŒ‰æ—¶é—´é¡ºåºç¼–å·
                        img.newName = `${images.length + 1}.${img.extension}`;
                    }
                    
                    images.push(img);
                    loadedCount++;
                    
                    // å½“æ‰€æœ‰æ–‡ä»¶éƒ½åŠ è½½å®Œæˆåï¼Œé‡æ–°æ’åºå’Œæ¸²æŸ“
                    if (loadedCount === sortedFiles.length) {
                        if (currentMode === 'normal') {
                            images.sort((a, b) => a.timestamp - b.timestamp);
                            images.forEach((img, index) => {
                                img.newName = `${index + 1}.${img.extension}`;
                            });
                        }
                        renderImages();
                    }
                };
                reader.readAsDataURL(file);
            });
            
            fileInput.value = '';
        });

        function renderImages() {
            status.textContent = `å·²é€‰æ‹© ${images.length} å¼ å›¾ç‰‡`;
            
            document.getElementById('clearBtn').style.display = images.length > 0 ? 'inline-block' : 'none';
            document.getElementById('exportBtn').style.display = images.length > 0 ? 'inline-block' : 'none';
            
            if (images.length === 0) {
                imageList.innerHTML = '';
                return;
            }
            
            // æ™®é€šæ¨¡å¼éœ€è¦é‡æ–°æŒ‰æ—¶é—´æ’åºå¹¶ç¼–å·
            if (currentMode === 'normal') {
                images.sort((a, b) => a.timestamp - b.timestamp);
                images.forEach((img, index) => {
                    img.newName = `${index + 1}.${img.extension}`;
                });
            }
            
            imageList.innerHTML = images.map(img => `
                <div class="image-item">
                    <img src="${img.dataUrl}" class="image-thumbnail" alt="preview">
                    <div class="image-info">
                        <div class="original-name">åŸæ–‡ä»¶å: ${img.originalName}</div>
                        <div class="new-name">
                            ${currentMode === 'unbox' ? `ç®±å·${img.boxNum} - ` : ''}
                            ${currentMode === 'receive' ? `è½¦æ¬¡${img.boxNum} - ` : ''}
                            æ–°æ–‡ä»¶å: ${img.newName}
                            ${(currentMode === 'unbox' || currentMode === 'receive') ? `<span class="pair-indicator pair-${img.posInBox}">${img.posInBox}</span>` : ''}
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeImage(${img.id})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function removeImage(id) {
            const removedImg = images.find(img => img.id === id);
            images = images.filter(img => img.id !== id);
            
            // æ”¶è´§æ¨¡å¼ï¼šåˆ é™¤ç…§ç‰‡åï¼ŒåŒè½¦çš„å…¶ä»–ç…§ç‰‡åºå·è¦é‡æ–°è®¡ç®—
            if (currentMode === 'receive' && removedImg) {
                const sameBoxImages = images.filter(img => img.boxNum === removedImg.boxNum);
                sameBoxImages.sort((a, b) => a.timestamp - b.timestamp);
                sameBoxImages.forEach((img, index) => {
                    img.posInBox = index + 1;
                    img.newName = `${img.boxNum}-${img.posInBox}.${img.extension}`;
                });
            }
            
            // å¼€ç®±æ¨¡å¼ï¼šåˆ é™¤ç…§ç‰‡åï¼ŒåŒç®±çš„å…¶ä»–ç…§ç‰‡åºå·è¦é‡æ–°è®¡ç®—
            if (currentMode === 'unbox' && removedImg) {
                const sameBoxImages = images.filter(img => img.boxNum === removedImg.boxNum);
                sameBoxImages.sort((a, b) => a.timestamp - b.timestamp);
                sameBoxImages.forEach((img, index) => {
                    img.posInBox = index + 1;
                    img.newName = `${img.boxNum}-${img.posInBox}.${img.extension}`;
                });
            }
            
            // æ™®é€šæ¨¡å¼ï¼šé‡æ–°è®¡ç®—ç¼–å·
            if (currentMode === 'normal') {
                images.sort((a, b) => a.timestamp - b.timestamp);
                images.forEach((img, index) => {
                    img.newName = `${index + 1}.${img.extension}`;
                });
            }
            
            renderImages();
        }

        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ')) {
                images = [];
                currentBoxNum = 1;
                currentPosInBox = 1;
                const label = currentMode === 'unbox' ? 'ç®±å·' : (currentMode === 'receive' ? 'è½¦æ¬¡' : '');
                if (document.getElementById('boxDisplay') && label) {
                    document.getElementById('boxDisplay').textContent = `${label} ${currentBoxNum}`;
                }
                renderImages();
            }
        }

        async function exportZip() {
            if (images.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }
            
            const exportBtn = document.getElementById('exportBtn');
            exportBtn.textContent = 'æ­£åœ¨æ‰“åŒ…...';
            exportBtn.disabled = true;

            try {
                const zip = new JSZip();
                
                images.forEach(img => {
                    zip.file(img.newName, img.file);
                });

                const content = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `images_${currentMode}_${Date.now()}.zip`;
                link.click();
                URL.revokeObjectURL(link.href);

                exportBtn.textContent = 'æ‰“åŒ…å¹¶å¯¼å‡º ZIP';
                exportBtn.disabled = false;
                alert('å‹ç¼©åŒ…å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                exportBtn.textContent = 'æ‰“åŒ…å¹¶å¯¼å‡º ZIP';
                exportBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
